version: '3.8'

services:
  # MySQL数据库
  db:
    image: mysql:8.0
    container_name: morphtesser-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: morphtesserdb
      MYSQL_USER: morphtesser
      MYSQL_PASSWORD: ${DB_PASSWORD:-morphtesser123}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      # MySQL 数据持久化卷（数据库文件存储位置）
      - db_data:/var/lib/mysql
      # MySQL 初始化脚本（首次启动空库时自动执行）
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "3307:3306"  # 使用3307映射容器内的3306，避免与本地MySQL冲突
    restart: unless-stopped
    networks:
      - morphtesser-network
    command: --default-authentication-plugin=mysql_native_password

  # 后端API服务 (Spring Boot) - 多阶段构建
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: morphtesser-backend
    ports:
      - "8080:8080"
    environment:
      # Spring配置
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/morphtesserdb?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-morphtesser}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-morphtesser123}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-prod}
      
      # Python建模API服务（通过内网穿透访问本地主机的API）
      # 格式：http://内网穿透公网地址:端口/swc2obj/
      PYTHON_MODELING_API_URL: ${PYTHON_MODELING_API_URL:-http://localhost:8000/swc2obj/}
      
      # ==================== 文件路径配置 ====================
      # 文件上传根目录（用户上传的文件存储位置）
      FILE_UPLOAD_DIR: /app/uploads
      # 数据根目录（包含所有数据集和数据文件）
      DATA_DIR: ${DATA_DIR:-/app/data}
      
      # ==================== 数据集路径配置 ====================
      # 1. 数据集上传基础目录
      #    用途：用户通过 Web 界面上传的数据集文件存储位置
      #    对应代码：DatasetController（需要修改硬编码路径）
      #    挂载映射：./uploads:/app/uploads（包含此子目录）
      DATASET_UPLOAD_BASE_DIR: ${DATASET_UPLOAD_BASE_DIR:-/app/uploads/datasets/}
      
      # 2. 公共数据库数据集路径
      #    用途：公共数据库功能的数据集存储位置（只读）
      #    对应代码：DatasetController.java 第 28 行 DATASETS_DIR（需修改：Y:/morphtesser_exp/Final_Results_Datasets/）
      #    挂载映射：./data/public-datasets:/app/data/public-datasets:ro
      #    目录结构：/app/data/public-datasets/{datasetId}/results/{modelId}/{file.swc|file.drc}
      DATASET_PUBLIC_BASE_DIR: ${DATASET_PUBLIC_BASE_DIR:-/app/data/public-datasets/}
      
      # 3. NeuroMorpho 插件本地数据集路径
      #    用途：NeuroMorpho 插件功能的本地数据集存储位置（只读）
      #    对应代码：application.properties（需修改：X:/morphtesser_exp/neuromorpho_08/results）
      #    挂载映射：./data/neuromorpho:/app/data/neuromorpho:ro
      DATASET_NEUROMORPHO_LOCAL_PATH: ${DATASET_NEUROMORPHO_LOCAL_PATH:-/app/data/neuromorpho/results}
      
      # 4. NeuroMorpho 插件远程访问地址
      #    用途：NeuroMorpho 插件功能的远程数据集访问地址（通过 SMB 或 HTTP）
      #    对应代码：application.properties（需修改：http://10.6.51.163:5000/shared/morphtesser_exp/neuromorpho_08）
      #    格式：http://服务器地址:端口/共享路径
      #    注意：如果数据集在远程服务器，配置此地址；如果使用本地路径，此项可为空
      DATASET_NEUROMORPHO_REMOTE_BASE: ${DATASET_NEUROMORPHO_REMOTE_BASE:-http://localhost:5000/shared/morphtesser_exp/neuromorpho_08}
      
      # 5. 数据集索引缓存目录
      #    用途：存储 SWC 文件列表的静态索引文件（JSON 格式）
      #    对应代码：DatasetController.java 第 29 行 STATIC_INDEX_DIR（需修改：morphtesser_web/backend/cache/swc-index/）
      #    挂载映射：./cache/swc-index:/app/cache/swc-index
      #    文件格式：{datasetId}.swc-list.json（例如：dataset1.swc-list.json）
      #    说明：用于加速数据集文件列表查询，避免每次扫描文件系统
      DATASET_INDEX_CACHE_DIR: ${DATASET_INDEX_CACHE_DIR:-/app/cache/swc-index/}
      
      # 6. 在线建模临时文件目录
      #    用途：在线建模功能生成的临时文件存储位置
      #    对应代码：application.properties（已启用：dataset.online-modeling.temp-dir）
      #    挂载映射：./temp/online-modeling:/app/temp/online-modeling
      #    特点：不保存到数据库，页面刷新后自动清理
      DATASET_ONLINE_MODELING_TEMP_DIR: ${DATASET_ONLINE_MODELING_TEMP_DIR:-/app/temp/online-modeling/}
      
      # 7. 在线建模临时文件清理时间（小时）
      #    用途：自动清理超过指定时间的临时文件
      #    对应代码：application.properties（已启用：dataset.online-modeling.cleanup.max-age-hours）
      #    默认值：1 小时（超过 1 小时的临时文件会被自动删除）
      #    说明：设置为 0 表示不自动清理，设置为负数表示立即清理
      DATASET_ONLINE_MODELING_CLEANUP_MAX_AGE_HOURS: ${DATASET_ONLINE_MODELING_CLEANUP_MAX_AGE_HOURS:-1}
      
      # SMB配置（如果需要）
      SMB_HOST: ${SMB_HOST:-}
      SMB_DOMAIN: ${SMB_DOMAIN:-}
      SMB_USERNAME: ${SMB_USERNAME:-}
      SMB_PASSWORD: ${SMB_PASSWORD:-}
      SMB_SHARE: ${SMB_SHARE:-}
      SMB_ROOT: ${SMB_ROOT:-}
      
      # JWT配置
      JWT_SECRET: ${JWT_SECRET:-morphtesserSecretKey1234567890123456789012345678901234567890123456789012345678901234}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      
      # 日志级别
      LOGGING_LEVEL_ROOT: ${LOG_LEVEL:-INFO}
    volumes:
      # 文件上传目录（用户上传的文件，包含 datasets 子目录）
      - ./uploads:/app/uploads
      # 公共数据集目录（只读，防止误删）
      - ${DATASET_PUBLIC_BASE_DIR:-./data/public-datasets}:/app/data/public-datasets:ro
      # NeuroMorpho 数据集目录（只读）
      - ${DATASET_NEUROMORPHO_LOCAL_PATH:-./data/neuromorpho}:/app/data/neuromorpho:ro
      # 数据集索引缓存目录（加快查询速度）
      - ./cache/swc-index:/app/cache/swc-index
      # 在线建模临时文件目录（自动清理）
      - ./temp/online-modeling:/app/temp/online-modeling
      # 后端日志目录
      - ./logs/backend:/app/logs
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - morphtesser-network

  # 前端服务 (Nginx) - 多阶段构建
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: morphtesser-frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # SSL 证书目录（只读，包含 fullchain.pem 和 privkey.pem）
      - ./ssl:/etc/nginx/ssl:ro
      # Nginx 日志目录
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - morphtesser-network

volumes:
  # MySQL 数据库持久化卷
  # 存储位置：Docker 管理的卷（通常在 /var/lib/docker/volumes/）
  # 特点：删除容器时数据不会丢失，除非使用 docker-compose down -v
  db_data:
    driver: local

networks:
  morphtesser-network:
    driver: bridge

